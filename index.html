<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>è®€æ›¸åŠ©æ‰‹ - å°ˆå±¬é›²ç«¯æ——è‰¦ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #5dade2; --secondary: #f39c12; --danger: #e74c3c; --success: #27ae60; --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --border: #333; --input-bg: #2a2a2a; }
        body.light-mode { --bg: #f4f7f6; --card: #ffffff; --text: #2c3e50; --border: #ddd; --input-bg: #f9f9f9; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); max-width: 500px; margin: auto; padding: 15px; transition: 0.3s; }
        .container { background: var(--card); padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .user-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .user-id-tag { font-size: 0.7rem; background: #333; color: var(--primary); padding: 4px 10px; border-radius: 20px; border: 1px solid var(--primary); }
        h2 { border-left: 5px solid var(--primary); padding-left: 10px; font-size: 1.1rem; margin: 20px 0 10px; color: var(--primary); }
        .input-group { display: flex; gap: 8px; margin-bottom: 12px; }
        input { padding: 10px; background: var(--input-bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); flex: 1; outline: none; }
        button { padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .timer-box { text-align: center; background: rgba(255,255,255,0.03); padding: 20px; border-radius: 12px; border: 1px solid var(--border); }
        .timer-display { font-size: 3.5rem; font-family: monospace; font-weight: bold; margin: 10px 0; color: var(--primary); }
        .sub-btn-group { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; justify-content: center; }
        .sub-tag { display: flex; align-items: center; background: #333; color: #eee; border-radius: 20px; padding: 2px 12px; font-size: 0.8rem; cursor: pointer; border: 1px solid transparent; }
        .sub-tag:hover { border-color: var(--primary); }
        .sub-del { margin-left: 8px; color: var(--danger); font-weight: bold; font-size: 1.1rem; }
        .list-container { border: 1px solid var(--border); border-radius: 10px; background: rgba(0,0,0,0.2); margin-bottom: 15px; max-height: 180px; overflow-y: auto; }
        .item { padding: 12px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; }
        .tag { background: var(--primary); color: #000; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="user-info">
        <span id="userTag" class="user-id-tag">ğŸ”‘ ç©ºé–“è¼‰å…¥ä¸­...</span>
        <button onclick="document.body.classList.toggle('light-mode')" style="font-size:0.7rem; background:#444; color:#fff;">ğŸŒ“ æ¨¡å¼</button>
    </div>
    
    <h1 style="font-size:1.3rem; margin:0; color:var(--primary);">è®€æ›¸åŠ©æ‰‹ Cloud Pro</h1>

    <h2>ğŸ“… è€ƒè©¦å€’æ•¸</h2>
    <div class="input-group">
        <input type="text" id="evName" placeholder="è€ƒè©¦åç¨±">
        <input type="date" id="evDate">
        <button style="background:var(--primary); color:#000" onclick="addEv()">æ–°å¢</button>
    </div>
    <div id="evList" class="list-container"></div>

    <h2>â±ï¸ å°ˆæ³¨è¨ˆæ™‚</h2>
    <div class="timer-box">
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <button id="mStudy" style="flex:1; background:var(--primary); color:#000;" onclick="setMode('study')">æ™®é€šè¨ˆæ™‚</button>
            <button id="mPomo" style="flex:1; background:#444; color:#fff;" onclick="setMode('pomo')">ç•ªèŒ„é˜</button>
        </div>
        <div class="timer-display" id="tDisp">00:00:00</div>
        
        <div id="pomoSet" style="display:none; margin-bottom:15px; font-size:0.8rem;">
            å°ˆæ³¨ <input type="number" id="pMin" value="25" style="width:45px;"> åˆ† | 
            ä¼‘æ¯ <input type="number" id="rMin" value="5" style="width:45px;"> åˆ†
        </div>

        <div class="sub-btn-group" id="subGroup"></div>
        <div class="input-group" style="margin-bottom:15px;">
            <input type="text" id="newSubName" placeholder="æ–°å¢è‡ªå®šç¾©ç§‘ç›®...">
            <button onclick="addSub()" style="background:#555; color:white;">ï¼‹</button>
        </div>

        <div class="input-group">
            <input type="text" id="subj" value="è‡ªä¸»å­¸ç¿’">
            <button id="sBtn" onclick="toggleTimer()" style="background:var(--success); color:white; flex:2;">é–‹å§‹</button>
            <button onclick="manualSave()" style="background:var(--secondary); color:white; flex:1;">å„²å­˜</button>
        </div>
    </div>

    <h2>ğŸ“Š å­¸ç¿’ç´€éŒ„</h2>
    <div id="logList" class="list-container"></div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAFgzkCDZLmrCQJ0h7NGl17S_d9joRZoPY",
        authDomain: "study-helper-d6815.firebaseapp.com",
        databaseURL: "https://study-helper-d6815-default-rtdb.firebaseio.com",
        projectId: "study-helper-d6815",
        storageBucket: "study-helper-d6815.firebasestorage.app",
        messagingSenderId: "908760745582",
        appId: "1:908760745582:web:2ead8ee0fdac19cd9f487f"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // å–å¾—ç¶²å€ ID
    const urlParams = new URLSearchParams(window.location.search);
    let userID = urlParams.get('id') || "public_space";
    document.getElementById('userTag').innerText = "ğŸ”‘ ç©ºé–“ ID: " + userID;

    let state = {
        evs: [], logs: [], subs: ["è‡ªä¸»å­¸ç¿’", "æ•¸å­¸", "è‹±æ–‡"],
        sec: 0, running: false, timer: null, mode: 'study', isRest: false, totalSetSec: 0
    };

    function loadData() {
        db.ref('users_data/' + userID).on('value', (snap) => {
            const data = snap.val();
            if (data) {
                state.evs = data.evs || [];
                state.logs = data.logs || [];
                state.subs = data.subs || ["è‡ªä¸»å­¸ç¿’", "æ•¸å­¸", "è‹±æ–‡"];
                render();
            }
        });
    }

    function sync() {
        db.ref('users_data/' + userID).set({
            evs: state.evs, logs: state.logs, subs: state.subs
        });
    }

    // ç§‘ç›®ç®¡ç†
    function addSub() {
        const name = document.getElementById('newSubName').value.trim();
        if(name && !state.subs.includes(name)) {
            state.subs.push(name);
            document.getElementById('newSubName').value = '';
            sync();
        }
    }
    function delSub(name) {
        if(confirm(`åˆªé™¤ã€Œ${name}ã€ï¼Ÿ`)) {
            state.subs = state.subs.filter(s => s !== name);
            sync();
        }
    }

    // è¨ˆæ™‚é‚è¼¯
    function setMode(m) {
        if (state.running) return;
        state.mode = m;
        document.getElementById('mStudy').style.background = m === 'study' ? 'var(--primary)' : '#444';
        document.getElementById('mPomo').style.background = m === 'pomo' ? 'var(--primary)' : '#444';
        document.getElementById('pomoSet').style.display = m === 'pomo' ? 'block' : 'none';
        resetTimer();
    }

    function toggleTimer() {
        if (state.running) {
            clearInterval(state.timer); state.running = false;
            document.getElementById('sBtn').innerText = "ç¹¼çºŒ";
        } else {
            if (state.mode === 'pomo' && state.sec === 0) {
                state.totalSetSec = document.getElementById('pMin').value * 60;
                state.sec = state.totalSetSec;
            }
            state.running = true;
            document.getElementById('sBtn').innerText = "æš«åœ";
            state.timer = setInterval(tick, 1000);
        }
    }

    function tick() {
        if (state.mode === 'study') state.sec++;
        else {
            state.sec--;
            if (state.sec <= 0) {
                clearInterval(state.timer); state.running = false;
                alert(state.isRest ? "ä¼‘æ¯çµæŸï¼" : "å°ˆæ³¨çµæŸï¼");
                if (!state.isRest) {
                    state.logs.unshift({id:Date.now(), subject:document.getElementById('subj').value, duration:state.totalSetSec});
                    sync();
                }
                state.isRest = !state.isRest;
                state.totalSetSec = (state.isRest ? document.getElementById('rMin').value : document.getElementById('pMin').value) * 60;
                state.sec = state.totalSetSec;
                document.getElementById('sBtn').innerText = "é–‹å§‹";
            }
        }
        updateDisplay();
    }

    function updateDisplay() {
        const h = Math.floor(state.sec/3600), m = Math.floor((state.sec%3600)/60), s = state.sec%60;
        document.getElementById('tDisp').innerText = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }

    function manualSave() {
        let dur = (state.mode === 'study') ? state.sec : (state.totalSetSec - state.sec);
        if (dur > 5) {
            state.logs.unshift({id:Date.now(), subject:document.getElementById('subj').value, duration:dur});
            sync(); resetTimer();
        }
    }

    function resetTimer() {
        clearInterval(state.timer); state.running = false;
        state.sec = (state.mode === 'pomo') ? document.getElementById('pMin').value * 60 : 0;
        updateDisplay(); document.getElementById('sBtn').innerText = "é–‹å§‹";
    }

    function render() {
        const today = new Date().setHours(0,0,0,0);
        document.getElementById('evList').innerHTML = state.evs.map(ev => `
            <div class="item"><span>${ev.n}</span><span>å‰© ${Math.ceil((new Date(ev.d)-today)/86400000)}å¤© <span onclick="delEv(${ev.id})" style="cursor:pointer;color:red">âœ•</span></span></div>
        `).join('');
        document.getElementById('logList').innerHTML = state.logs.slice(0,10).map(l => `
            <div class="item"><span><span class="tag">${l.subject}</span> ${Math.floor(l.duration/60)}åˆ†${l.duration%60}ç§’</span><span onclick="delLog(${l.id})" style="cursor:pointer;color:red">âœ•</span></div>
        `).join('');
        document.getElementById('subGroup').innerHTML = state.subs.map(s => `
            <div class="sub-tag">
                <span onclick="document.getElementById('subj').value='${s}'">${s}</span>
                <span class="sub-del" onclick="event.stopPropagation(); delSub('${s}')">Ã—</span>
            </div>
        `).join('');
    }

    function addEv() {
        const n = document.getElementById('evName').value, d = document.getElementById('evDate').value;
        if(n && d) { state.evs.push({id:Date.now(), n, d}); sync(); }
    }
    function delEv(id) { state.evs = state.evs.filter(e => e.id !== id); sync(); }
    function delLog(id) { state.logs = state.logs.filter(l => l.id !== id); sync(); }

    loadData();
</script>
</body>
</html>